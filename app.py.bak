#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import json
import uuid
from datetime import datetime
from pathlib import Path
import time


from flask import Flask, request, jsonify, render_template_string, redirect

# ---------------------------
# Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ / ÎœÎŸÎÎ™ÎœÎ‘ ÎœÎŸÎÎŸÎ Î‘Î¤Î™Î‘
# ---------------------------
BASE_DIR = Path("/opt/raspipush_ultimate")
DATA_DIR = BASE_DIR / "data"
STATIC_DIR = BASE_DIR / "static"
ICONS_DIR = STATIC_DIR / "icons"

DATA_DIR.mkdir(parents=True, exist_ok=True)

LOG_FILE = DATA_DIR / "logs.json"       # Î»Î¯ÏƒÏ„Î± Î¼Îµ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î­Ï‚
EVENTS_FILE = DATA_DIR / "events.json"  # dict: {event_id: {...}}

# ---------------------------
# Î Î‘Î¡ÎŸÎ§ÎŸÎ£ / ENV VARS
# ---------------------------
# Î’Î¬Î»Îµ Ï„Î± env Ï€ÏÎ¹Î½ Ï„ÏÎ­Î¾ÎµÎ¹ Ï„Î¿ service (Ï€.Ï‡. ÏƒÎµ /etc/environment Î® ÏƒÏ„Î¿ unit file)
# export YUBOTO_API_KEY="...."
# export YUBOTO_SENDER="FDTeam 2012"
# export PUBLIC_BASE_URL="https://app.fdteam2012.gr"

YUBOTO_API_KEY = os.getenv("YUBOTO_API_KEY", "").strip()
YUBOTO_SENDER = os.getenv("YUBOTO_SENDER", "FDTeam 2012").strip()
PUBLIC_BASE_URL = os.getenv("PUBLIC_BASE_URL", "http://127.0.0.1:8899").strip()
YUBOTO_AUTH_HEADER = os.getenv("YUBOTO_AUTH_HEADER", "X-API-KEY").strip()

# Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬: Î±Î»Î»Î¬Î¶ÎµÎ¹Ï‚ endpoint/headers Î±Î½ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯
YUBOTO_API_URL = os.getenv("YUBOTO_API_URL", "https://api.yuboto.com/v1/sms/send").strip()
# ÎšÎ¬Ï€Î¿Î¹Î± APIs Î¸Î­Î»Î¿Ï…Î½ "X-API-KEY", Î¬Î»Î»Î± "Authorization: Bearer ..."
YUBOTO_AUTH_HEADER = os.getenv("YUBOTO_AUTH_HEADER", "X-API-KEY").strip()  # "X-API-KEY" Î® "Authorization"

# ---------------------------
# Î’ÎŸÎ—Î˜Î—Î¤Î™ÎšÎ•Î£ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£
# ---------------------------

def _load_json(path, default):
    try:
        if path.exists():
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception:
        pass
    return default

def _save_json(path, data):
    tmp = path.with_suffix(".tmp")
    with open(tmp, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    tmp.replace(path)

def now_iso():
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def short_id():
    return uuid.uuid4().hex[:8]

def ensure_events():
    data = _load_json(EVENTS_FILE, {})
    if not isinstance(data, dict):
        data = {}
    return data

def ensure_logs():
    data = _load_json(LOG_FILE, [])
    if not isinstance(data, list):
        data = []
    return data

# ---------------------------
# YUBOTO Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— (SAFE)
# ---------------------------
import requests

def send_sms_yuboto(message, recipients):
    """
    Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ (ok: bool, provider_response: dict|str)
    Î‘Î½ Î»ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ API KEY â†’ mock mode (ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ ok=True Î±Î»Î»Î¬ Î´ÎµÎ½ ÏƒÏ„Î­Î»Î½ÎµÎ¹).
    """
    if not recipients:
        return False, {"error": "No recipients"}

    # Mock mode ÏŒÏ„Î±Î½ Î´ÎµÎ½ Î­Ï‡Î¿Ï…Î¼Îµ API key (Î³Î¹Î± Î½Î± Î¼Î· ÏƒÎºÎ¬ÎµÎ¹)
    if not YUBOTO_API_KEY:
        return True, {"mock": True, "info": "No YUBOTO_API_KEY. Message not actually sent."}

    headers = {}
    # Î‘Î½ Î¸ÎµÏ‚ "Authorization: Bearer XXX" Î²Î¬Î»Îµ YUBOTO_AUTH_HEADER=Authorization ÎºÎ±Î¹ API_KEY="Bearer XXX"
    if YUBOTO_AUTH_HEADER.lower().startswith("authorization"):
        # Î¸Î± Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ Ï„Î¹Î¼Î® Ï„ÏÏ€Î¿Ï… "Bearer <TOKEN>"
        headers["Authorization"] = YUBOTO_API_KEY
    else:
        headers[YUBOTO_AUTH_HEADER] = YUBOTO_API_KEY

    payload = {
        "sender": YUBOTO_SENDER,
        "message": message,
        "recipients": recipients
    }

    try:
        resp = requests.post(YUBOTO_API_URL, json=payload, headers=headers, timeout=10)
        ok = (200 <= resp.status_code < 300)
        try:
            data = resp.json()
        except Exception:
            data = {"text": resp.text}
        return ok, {"status_code": resp.status_code, "data": data}
    except Exception as e:
        return False, {"exception": str(e)}

# ---------------------------
# FLASK
# ---------------------------
app = Flask(__name__, static_folder="static", static_url_path="/static")

# ---------------------------
# Î‘Î¡Î§Î™ÎšÎ— Î£Î•Î›Î™Î”Î‘ (UI)
# ---------------------------
@app.route("/")
def index():
    html = """
    <!DOCTYPE html>
    <html lang="el">
    <head>
        <meta charset="UTF-8">
        <title>RasPi Push Ultimate</title>
        <style>
            body { background-color: #121212; color: #f1f1f1; font-family: Arial, sans-serif; margin: 40px; }
            input, textarea, button { width: 100%; margin: 8px 0; padding: 8px; border-radius: 6px; border: none; }
            input, textarea { background-color: #222; color: #fff; }
            button { background-color: #2196f3; color: #fff; cursor: pointer; }
            button:hover { background-color: #0b7dda; }
            .card { background-color: #1e1e1e; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); max-width: 600px; margin: auto; }
            label { font-weight: bold; }
            h2 { color: #03A9F4; }
        </style>
    </head>
    <body>
        <div class="card">
            <h2>Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® SMS (Yuboto)</h2>

            <form id="sendForm" method="post" action="/send">

                <label for="phones">Î¤Î·Î»Î­Ï†Ï‰Î½Î¿(Î±):</label>
                <input type="text" id="phones" name="phones" placeholder="Ï€.Ï‡. 6945414565, 6932123456">

                <label for="place">Î“Î®Ï€ÎµÎ´Î¿:</label>
                <input type="text" id="place" name="place" placeholder="Ï€.Ï‡. Î”Î±Î²Î¿Ï…ÏÎ»Î®Ï‚">

                <label for="date">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±:</label>
                <input type="date" id="date" name="date">

                <label for="time">ÎÏÎ±:</label>
                <input type="time" id="time" name="time">

                <br>
                <button type="submit">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
            </form>
        </div>
    </body>
    </html>
    """
    return html

# ---------------------------
# Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— SMS + Î”Î—ÎœÎ™ÎŸÎ¥Î¡Î“Î™Î‘ LANDING
# ---------------------------
@app.route("/send", methods=["POST"])
def api_send():
    # Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· ÎºÎ±Î¹ Î³Î¹Î± JSON ÎºÎ±Î¹ Î³Î¹Î± Ï†ÏŒÏÎ¼Î±
    if request.is_json:
        data = request.get_json()
    else:
        data = request.form.to_dict()

    raw_numbers = data.get("phones", "")
    print("ğŸ§© raw_numbers debug:", raw_numbers)

    # ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÎºÎ±Î¹ Î¼Î¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±ÏÎ¹Î¸Î¼ÏÎ½
    numbers = []
    for num in raw_numbers.replace("\n", ",").split(","):
        num = num.strip()
        if num:
            if not num.startswith("+30"):
                if num.startswith("30"):
                    num = "+" + num
                elif num.startswith("0"):
                    num = "+30" + num[1:]
                else:
                    num = "+30" + num
            numbers.append(num)

    if not numbers:
        return jsonify({"error": "No valid numbers"}), 400

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚
    msg_id = uuid.uuid4().hex[:8]
    message_text = (
        f"Flying Dads Team âš½\n"
        f"Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·: Î Î±Î¯Î¶Î¿Ï…Î¼Îµ ÏƒÏ„Î¿ {data.get('place', 'Î³Î®Ï€ÎµÎ´Î¿')} "
        f"Ï„Î·Î½ {data.get('date', 'Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±')} ÏÏÎ± {data.get('time', 'ÏÏÎ±')}!\n"
        f"ğŸ‘‰ Î”ÎµÏ‚ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ±: {PUBLIC_BASE_URL}/r?id={msg_id}"
    )

    # Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ Yuboto API
    payload = {
        "sender": YUBOTO_SENDER,
        "message": message_text,
        "recipients": numbers,
    }

    headers = {YUBOTO_AUTH_HEADER: YUBOTO_API_KEY, "Content-Type": "application/json"}

    print("ğŸ“¤ Sending payload:", payload)
    try:
        response = requests.post("https://sms.yuboto.com/api/v2/send",
                                 json=payload, headers=headers, timeout=10)
        provider_response = response.text
        print("âœ… provider_response:", provider_response)
    except Exception as e:
        provider_response = str(e)
        print("âŒ provider_error:", provider_response)

    # Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ logs
    log_entry = {
        "id": msg_id,
        "phones": numbers,
        "text": message_text,
        "provider_response": provider_response,
        "timestamp": time.strftime("%Y-%m-%d %H:%M:%S"),
    }

    logs = _load_json(LOG_FILE, [])
    logs.insert(0, log_entry)
    _save_json(LOG_FILE, logs)

    return jsonify({"status": "ok", "msg_id": msg_id})


# ---------------------------
# Î™Î£Î¤ÎŸÎ¡Î™ÎšÎŸ (JSON)
# ---------------------------
@app.route("/history", methods=["GET"])
def api_history():
    logs = ensure_logs()
    return jsonify(logs)

# ---------------------------
# LANDING PAGE (r?id=<event_id>)
# ---------------------------
@app.route("/r")
def landing():
    event_id = (request.args.get("id") or "").strip()
    events = ensure_events()
    ev = events.get(event_id)

    if not ev:
        return render_template_string("""
<!DOCTYPE html><html lang="el"><meta charset="utf-8">
<title>FDTeam â€” Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ</title>
<body style="background:#0b0f14;color:#e8eef5;font-family:sans-serif;text-align:center;padding:40px">
<h2>âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î· Ï…Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·</h2>
<p>ÎŠÏƒÏ‰Ï‚ Î­Ï‡ÎµÎ¹ Î»Î®Î¾ÎµÎ¹ Î® Ï„Î¿ link ÎµÎ¯Î½Î±Î¹ Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½Î¿.</p>
</body></html>
        """)

    html = """
<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FDTeam â€” Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</title>
<link rel="icon" href="/static/favicon.ico">
<style>
body{ margin:0; background: radial-gradient(900px 400px at 50% -10%, #131a22, #070a0e); color:#e8eef5;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; text-align:center; }
.wrap{ max-width:760px; padding:22px; margin:0 auto; }
.logo{ width:82px; height:82px; object-fit:contain; margin-top:26px; filter: drop-shadow(0 0 12px #ff3b3b99); }
.card{ background:#111821; border:1px solid #000; border-radius:16px; padding:16px; margin:18px 0; box-shadow:0 10px 24px #000c;}
.btn{
  background:#ff3b3b; color:#fff; padding:12px 18px; border:none; border-radius:12px; font-weight:700; cursor:pointer;
  transition:.2s;
}
.btn:hover{ filter:brightness(1.1); box-shadow:0 0 18px #ff3b3b66; }
.msg{ white-space: pre-wrap; text-align:left; background:#0a0f14; border:1px solid #0e1a26; border-radius:14px; padding:12px; }
.small{ color:#9fb3c8; font-size:.9rem;}
.ok{ color:#9ad29a; font-weight:700; }
</style>
</head>
<body>
<div class="wrap">
  <img src="/static/icons/logo_final.png" alt="FDTeam" class="logo">
  <h2>FDTeam â€” Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î›Î®ÏˆÎ·Ï‚</h2>
  <div class="card">
    <div class="msg">{{message}}</div>
    <p id="seen-status" class="small">Î Î¬Ï„Î·ÏƒÎµ Â«Î¤Î¿ ÎµÎ¯Î´Î±Â» Î³Î¹Î± Î½Î± ÎºÎ±Ï„Î±Î³ÏÎ±Ï†ÎµÎ¯.</p>
    <button class="btn" onclick="markSeen()">âœ… Î¤Î¿ ÎµÎ¯Î´Î±</button>
  </div>
  <p class="small">Â© 2025 FDTeam2012</p>
</div>
<script>
async function markSeen(){
  const res = await fetch("/seen",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ id: "{{event_id}}" })
  });
  const data = await res.json();
  document.getElementById("seen-status").innerHTML = data.ok ? "âœ… ÎšÎ±Ï„Î±Î³ÏÎ¬Ï†Î·ÎºÎµ!" : "âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î±.";
}
</script>
</body>
</html>
    """
    # Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ f-string. Î‘ÏƒÏ†Î±Î»Î®Ï‚ Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¼Îµ render_template_string
    return render_template_string(html, message=ev.get("message",""), event_id=event_id)

# ---------------------------
# Î•Î Î™Î’Î•Î’Î‘Î™Î©Î£Î— Â«Î¤ÎŸ Î•Î™Î”Î‘Â»
# ---------------------------
@app.route("/seen", methods=["POST"])
def api_seen():
    payload = request.get_json(silent=True) or {}
    event_id = (payload.get("id") or "").strip()
    events = ensure_events()
    ev = events.get(event_id)
    if not ev:
        return jsonify({"ok": False, "error": "not_found"}), 404
    if not ev.get("seen"):
        ev["seen"] = True
        ev["seen_at"] = now_iso()
        _save_json(EVENTS_FILE, events)
    return jsonify({"ok": True})

# ---------------------------
# MAIN (Î³Î¹Î± manual run, ÏƒÎµ systemd Î®Î´Î· Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ ExecStart)
# ---------------------------
if __name__ == "__main__":
    # Î£Îµ Ï„Î¿Ï€Î¹ÎºÏŒ debug: python3 app.py
    app.run(host="0.0.0.0", port=8899)
