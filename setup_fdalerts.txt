#!/bin/bash
set -e

SERVICE_NAME="fdalerts.service"
APP_DIR="/opt/raspipush_ultimate"
REPO_ZIP_URL="https://github.com/maxsto73/fdalerts-app/archive/refs/heads/main.zip"
TMP_DIR="/tmp/fdalerts-app-main"

clear
echo "======================================="
echo " ğŸš€ FD Alerts Setup Utility"
echo "======================================="
echo ""
echo "1) Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·"
echo "2) Î‘Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·"
echo "3) Î•Ï€Î±Î½ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·"
echo "4) Î ÏÎ¿Î²Î¿Î»Î® logs"
echo ""
read -p "ğŸ‘‰ Î•Ï€Î¹Î»Î¿Î³Î® (1-4): " CHOICE

case "$CHOICE" in
1)
    echo ""
    echo "ğŸ”§ ÎÎµÎºÎ¹Î½Î¬ Î· ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· FD Alerts..."
    read -p "ğŸ”¢ Î˜ÏÏÎ± (default 8899): " PORT
    PORT=${PORT:-8899}

    echo "ğŸ“¦ ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± Î±ÏÏ‡ÎµÎ¯Ï‰Î½..."
    sudo rm -rf $TMP_DIR
    cd /tmp
    curl -L -o fdalerts.zip "$REPO_ZIP_URL" >/dev/null 2>&1
    unzip -qo fdalerts.zip

    echo "ğŸ“ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚..."
    sudo rm -rf $APP_DIR
    sudo mkdir -p $APP_DIR
    sudo cp -r $TMP_DIR/* $APP_DIR
    sudo chown -R pi:pi $APP_DIR

    echo "ğŸ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Python venv..."
    sudo apt update -y >/dev/null
    sudo apt install -y python3-full python3-venv python3-pip unzip >/dev/null
    sudo python3 -m venv $APP_DIR/venv
    sudo chown -R pi:pi $APP_DIR/venv
    source $APP_DIR/venv/bin/activate
    pip install --upgrade pip --break-system-packages >/dev/null
    pip install flask requests python-dotenv --break-system-packages >/dev/null
    deactivate

    echo "âš™ï¸ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± systemd service..."
    sudo bash -c "cat > /etc/systemd/system/$SERVICE_NAME" <<EOF
[Unit]
Description=FD Alerts Flask Service
After=network.target

[Service]
WorkingDirectory=$APP_DIR
ExecStart=$APP_DIR/venv/bin/python $APP_DIR/app.py
Restart=always
User=pi
Environment="PORT=$PORT"

[Install]
WantedBy=multi-user.target
EOF

    echo "ğŸ” Î•ÎºÎºÎ¯Î½Î·ÏƒÎ· Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚..."
    sudo systemctl daemon-reexec
    sudo systemctl daemon-reload
    sudo systemctl enable $SERVICE_NAME
    sudo systemctl restart $SERVICE_NAME || true
    sleep 3

    if systemctl is-active --quiet $SERVICE_NAME; then
        echo ""
        echo "âœ… FD Alerts ÎµÎ³ÎºÎ±Ï„Î±ÏƒÏ„Î¬Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!"
        echo "ğŸŒ Î†Î½Î¿Î¹Î¾Îµ: http://$(hostname -I | awk '{print $1}'):$PORT"
    else
        echo "âš ï¸ Î¤Î¿ service Î´ÎµÎ½ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ ÏƒÏ‰ÏƒÏ„Î¬:"
        sudo journalctl -u $SERVICE_NAME -n 10 --no-pager
    fi
    ;;
2)
    echo "ğŸ§¹ Î‘Ï€ÎµÎ³ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹ FD Alerts..."
    sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
    sudo systemctl disable $SERVICE_NAME 2>/dev/null || true
    sudo rm -f /etc/systemd/system/$SERVICE_NAME
    sudo rm -rf $APP_DIR
    sudo systemctl daemon-reload
    echo "âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ Î· Î±Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·."
    ;;
3)
    echo "â™»ï¸ Î•Ï€Î±Î½ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·..."
    sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
    cd /tmp
    curl -L -o fdalerts.zip "$REPO_ZIP_URL" >/dev/null 2>&1
    unzip -qo fdalerts.zip
    sudo cp -r $TMP_DIR/* $APP_DIR
    sudo chown -R pi:pi $APP_DIR
    sudo systemctl restart $SERVICE_NAME
    sleep 2
    systemctl status $SERVICE_NAME --no-pager -n 5
    ;;
4)
    echo "ğŸ“œ Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± logs:"
    sudo journalctl -u $SERVICE_NAME -n 20 --no-pager
    ;;
*)
    echo "âŒ ÎœÎ· Î­Î³ÎºÏ…ÏÎ· ÎµÏ€Î¹Î»Î¿Î³Î®."
    ;;
esac
