#!/bin/bash
set -e

APP_DIR="/opt/raspipush_ultimate"
SERVICE_NAME="fdalerts.service"
REPO_ZIP="https://github.com/maxsto73/fdalerts-app/archive/refs/heads/main.zip"

echo "======================================="
echo " ðŸš€ FD Alerts Auto Installer"
echo "======================================="

echo "ðŸ§¹ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€Î±Î»Î±Î¹ÏŒÏ„ÎµÏÎ·Ï‚ ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚..."
sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
sudo rm -rf $APP_DIR
sudo mkdir -p $APP_DIR

echo "â¬‡ï¸  Î›Î®ÏˆÎ· ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Î±Ï€ÏŒ GitHub..."
cd /tmp
sudo rm -f fdalerts.zip
wget -q -O fdalerts.zip $REPO_ZIP

echo "ðŸ“¦ Î‘Ï€Î¿ÏƒÏ…Î¼Ï€Î¯ÎµÏƒÎ·..."
sudo unzip -q fdalerts.zip -d /tmp
sudo mv /tmp/fdalerts-app-main/* $APP_DIR/

echo "ðŸ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Python virtual environment..."
sudo apt update -y
sudo apt install -y python3 python3-venv python3-pip unzip
cd $APP_DIR
sudo python3 -m venv venv
sudo $APP_DIR/venv/bin/pip install --no-cache-dir flask requests

echo "âš™ï¸  Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± systemd service..."
sudo bash -c "cat > /etc/systemd/system/$SERVICE_NAME" <<EOF
[Unit]
Description=FD Alerts Flask Service
After=network.target

[Service]
WorkingDirectory=$APP_DIR
ExecStart=$APP_DIR/venv/bin/python $APP_DIR/app.py
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
EOF

echo "ðŸ” Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚..."
sudo systemctl daemon-reload
sudo systemctl enable $SERVICE_NAME
sudo systemctl restart $SERVICE_NAME

sleep 3
echo ""
if sudo systemctl is-active --quiet $SERVICE_NAME; then
    echo "âœ… Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏŽÏ‚!"
    echo "ðŸŒ Î†Î½Î¿Î¹Î¾Îµ: http://$(hostname -I | awk '{print $1}'):8899"
else
    echo "âš ï¸ Î¤Î¿ service Î´ÎµÎ½ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ ÏƒÏ‰ÏƒÏ„Î¬. Î”ÎµÏ‚ Ï„Î± logs:"
    sudo journalctl -u $SERVICE_NAME -n 10 --no-pager
fi
