<!doctype html>
<html lang="el">
  <head>
    <meta charset="utf-8" />
    <title>FD Alerts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/styles.css">
    <style>
      body {
        background: #0f172a;
        color: #e2e8f0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
      }
      header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: .75rem 1.5rem;
        background: rgba(15,23,42,.6);
        border-bottom: 1px solid rgba(148,163,184,.12);
      }
      header img { height: 42px; }
      main { max-width: 1100px; margin: 1.5rem auto 3rem; padding: 0 1rem; }
      .card {
        background: rgba(15,23,42,.35);
        border: 1px solid rgba(148,163,184,.08);
        border-radius: 1rem;
        padding: 1rem 1.25rem 1.25rem;
        margin-bottom: 1rem;
      }
      label { display: block; font-weight: 500; margin-bottom: .35rem; }
      input[type="text"], input[type="date"], input[type="time"], textarea {
        width: 100%;
        background: rgba(15,23,42,.3);
        border: 1px solid rgba(148,163,184,.25);
        border-radius: .5rem;
        padding: .4rem .6rem;
        color: #e2e8f0;
      }
      textarea { min-height: 90px; }
      .grid {
        display: grid;
        gap: .75rem;
      }
      .grid-3 {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      button {
        background: #2563eb;
        border: none;
        color: #fff;
        padding: .6rem 1.2rem;
        border-radius: .6rem;
        font-weight: 600;
        cursor: pointer;
      }
      button:disabled { opacity: .35; cursor: not-allowed; }
      h2 { margin-top: .4rem; }
      .logs ul, .views ul { list-style: none; padding: 0; margin: 0; }
      .logs li, .views li {
        padding: .3rem 0;
        border-bottom: 1px solid rgba(148,163,184,.04);
        font-size: .8rem;
      }
      .small-muted { font-size: .7rem; opacity: .6; }
      .top-actions { display: flex; gap: .5rem; align-items: center; }
      .top-actions a {
        color: #e2e8f0;
        background: rgba(37,99,235,.25);
        padding: .3rem .55rem;
        border-radius: .45rem;
        font-size: .75rem;
        text-decoration: none;
      }
    </style>
    <script>
      let selectedRecipients = [];

      async function sendSMS() {
        const date = document.getElementById('match_date').value;
        const time = document.getElementById('match_time').value;
        const place = document.getElementById('match_place').value;
        const custom = document.getElementById('custom_text').value;

        // recipients έρχονται από contacts tab -> αποθηκεύονται σε file
        // εδώ θα πάρουμε από hidden input (το γεμίζουμε όταν γυρνάμε από contacts)
        const rec = document.getElementById('recipients').value.trim();

        if (!rec) {
          alert("Δεν επιλέχθηκαν παραλήπτες");
          return;
        }

        const fd = new FormData();
        fd.append('match_date', date);
        fd.append('match_time', time);
        fd.append('match_place', place);
        fd.append('custom_text', custom);
        fd.append('recipients', rec);

        const btn = document.getElementById('send_btn');
        btn.disabled = true;
        try {
          const resp = await fetch('/send', { method: 'POST', body: fd });
          const data = await resp.json();
          if (data.ok) {
            alert("✅ Το SMS στάλθηκε");
            document.getElementById('custom_text').value = '';
          } else {
            alert("❌ Αποτυχία: " + (data.error || JSON.stringify(data.info)));
          }
        } catch (e) {
          alert("Σφάλμα αποστολής");
        } finally {
          btn.disabled = false;
        }
      }

      function buildPreview() {
        const date = document.getElementById('match_date').value || "_____";
        const time = document.getElementById('match_time').value || "__:__";
        const place = document.getElementById('match_place').value || "_____";
        const custom = document.getElementById('custom_text').value;
        let msg = "";
        if (custom) {
          msg = custom;
        } else {
          msg = `⚽ Flying Dads Team υπενθύμιση!\nΠαίζουμε μπαλίτσα στο ${place} την ${date} ώρα ${time}`;
        }
        document.getElementById('preview').textContent = msg;
      }

      window.addEventListener('DOMContentLoaded', () => {
        ['match_date','match_time','match_place','custom_text'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('input', buildPreview);
        });
        buildPreview();
      });
        window.addEventListener('DOMContentLoaded', () => {
    // φόρτωσε τους επιλεγμένους παραλήπτες από το localStorage
    const sel = localStorage.getItem("fdalerts_selected") || "";
    document.getElementById('recipients').value = sel;
    document.getElementById('selected-count').textContent = sel ? sel.split(",").filter(x => x).length : 0;

    // φτιάξε την προεπισκόπηση
    ['match_date','match_time','match_place','custom_text'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', buildPreview);
    });
    buildPreview();
  });
		function clearRecipients() {
		localStorage.removeItem("fdalerts_selected");
		document.getElementById("recipients").value = "";
		document.getElementById("selected-count").textContent = "0";
		alert("Οι παραλήπτες καθαρίστηκαν ✅");
	}
    </script>
  </head>
  <body>
    <header>
      <img src="/static/icons/logo_final.png" alt="FD" />
      <div>
        <div><strong>FD Alerts</strong></div>
        <div class="small-muted">Πόρτα: {{ port }} • Provider: {{ sms_provider }}</div>
      </div>
      <div class="top-actions" style="margin-left:auto">
        <a href="/contacts"> Επαφές</a>
      </div>
    </header>

    <main>
      <div class="card">
        <h2>Αποστολή ειδοποίησης</h2>
        <p class="small-muted">Συμπλήρωσε ημερομηνία, ώρα, γήπεδο ή γράψε δικό σου μήνυμα.</p>
        <div class="grid grid-3">
          <div>
            <label for="match_date">Ημερομηνία</label>
            <input type="date" id="match_date" name="match_date">
          </div>
          <div>
            <label for="match_time">Ώρα</label>
            <input type="time" id="match_time" name="match_time">
          </div>
          <div>
            <label for="match_place">Γήπεδο</label>
            <input type="text" id="match_place" name="match_place" placeholder="π.χ. Δαβουρλής">
          </div>
        </div>

        <label for="custom_text" style="margin-top:.7rem;">Ελεύθερο κείμενο (προαιρετικό)</label>
        <textarea id="custom_text" name="custom_text" placeholder="Αν το αφήσεις κενό, θα σταλεί το προδιαμορφωμένο μήνυμα."></textarea>

        <!-- εδώ θα μπαίνουν τα κινητά που διάλεξες από /contacts -->
        <input type="hidden" id="recipients" name="recipients" value="">
        <p class="small-muted">Επιλεγμένοι παραλήπτες: <span id="selected-count">0</span></p>

        <label>Προεπισκόπηση</label>
        <pre id="preview" style="background:rgba(15,23,42,.25);border:1px solid rgba(148,163,184,.08);padding:.5rem .6rem;border-radius:.5rem;white-space:pre-wrap;"></pre>

        <button id="send_btn" onclick="sendSMS()"> Αποστολή SMS</button>
        <button type="button" class="btn btn-warning" onclick="clearRecipients()">Καθαρισμός Παραληπτών</button>
      </div>
		
      <div class="card views">
        <h3>Ποιος πάτησε "Το είδα"</h3>
        <ul>
          {% for v in views %}
            <li>{{ v.ts }} — {{ v.name }} (id: {{ v.id }})</li>
          {% else %}
            <li class="small-muted">Κανείς ακόμα.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="card logs">
        <h3>Τελευταίες αποστολές</h3>
        <ul>
          {% for l in logs %}
            <li>
              {{ l.ts }} → {{ l.recipients|join(', ') }}
              <div class="small-muted">{{ l.message }}</div>
            </li>
          {% else %}
            <li class="small-muted">Δεν υπάρχουν ακόμα αποστολές.</li>
          {% endfor %}
        </ul>
      </div>
    </main>
  </body>
</html>
